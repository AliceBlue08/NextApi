.dotnet-job: &dotnet-job
  image: hub.abitech.kz/microsoft/dotnet:latest
  tags:
    - docker

.docker-job: &docker-job
  image: hub.abitech.kz/docker:latest
  tags:
    - docker

.docker: &docker
  tags:
    - docker

.dotnet-restore: &dotnet-restore "dotnet restore -v q --configfile ../../NuGet.config"

variables:
  VERSION: "1.0.0.$CI_PIPELINE_ID"

stages:
  - test
  - nugetize
  
test:
  <<: *dotnet-job
  stage: test
  script:
     - cd test/Abitech.NextApi.Server.Tests
     - *dotnet-restore
     - dotnet test -v n
     - cd ../Abitech.NextApi.Client.DI.Tests
     - *dotnet-restore
     - dotnet test -v n
nugetize: 
  <<: *dotnet-job
  only:
     - master@development/common/abitech.nextapi
  stage: nugetize
  script:
     - sed -i "s/<Version>1.0.0<\/Version>/<Version>$VERSION<\/Version>/g" src/Abitech.NextApi.Server/Abitech.NextApi.Server.csproj
     - sed -i "s/<Version>1.0.0<\/Version>/<Version>$VERSION<\/Version>/g" src/Abitech.NextApi.Client/Abitech.NextApi.Client.csproj
     - sed -i "s/<Version>1.0.0<\/Version>/<Version>$VERSION<\/Version>/g" src/Abitech.NextApi.Model/Abitech.NextApi.Model.csproj
     - cd src/Abitech.NextApi.Client
     - dotnet pack
     - dotnet nuget push "bin/Debug/Abitech.NextApi.Client.$VERSION.nupkg" -k $NugetApiKey  -s $NugetSource
     - cd ../Abitech.NextApi.Server
     - dotnet pack
     - dotnet nuget push "bin/Debug/Abitech.NextApi.Server.$VERSION.nupkg" -k $NugetApiKey  -s $NugetSource
     - cd ../Abitech.NextApi.Model
     - dotnet pack
     - dotnet nuget push "bin/Debug/Abitech.NextApi.Model.$VERSION.nupkg" -k $NugetApiKey  -s $NugetSource

nugetize-client-di:
  <<: *dotnet-job
  stage: nugetize
  when: manual
  only:
    - master@development/common/abitech.nextapi
  script:
    - cd src/Abitech.NextApi.Client.DI
    - sed -i "s/<Version>1.0.0<\/Version>/<Version>$VERSION<\/Version>/g" Abitech.NextApi.Client.DI.csproj
    - dotnet pack
    - dotnet nuget push "bin/Debug/Abitech.NextApi.Client.DI.$VERSION.nupkg" -k $NugetApiKey  -s $NugetSource
